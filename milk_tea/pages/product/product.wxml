<!-- pages/product/product.wxml -->
<view class="product-detail-page">
  <!-- å•†å“å›¾ç‰‡åŒºåŸŸ -->
  <view class="product-images">
    <swiper class="product-swiper" indicator-dots="{{true}}" autoplay="{{false}}" circular="{{true}}">
      <block wx:for="{{product.images}}" wx:key="index">
        <swiper-item>
          <image 
            src="{{item}}" 
            class="product-image" 
            mode="aspectFill"
            binderror="onImageError"
            bindload="onImageLoad"
          ></image>
        </swiper-item>
      </block>
    </swiper>
    
    <!-- æ”¶è—æŒ‰é’® -->
    <view 
      class="favorite-btn {{isFavorite ? 'active' : ''}}" 
      bindtap="toggleFavorite"
    >
      <image 
        class="favorite-icon"
        src="{{isFavorite ? '/images/icons/heart-fill.png' : '/images/icons/heart.png'}}"
      ></image>
    </view>
    
    <!-- å›¾ç‰‡æŒ‡ç¤ºå™¨ -->
    <view class="image-indicator">
      <text>{{currentImageIndex + 1}}/{{product.images.length}}</text>
    </view>
  </view>

  <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
  <view class="product-basic-info card">
    <view class="product-header">
      <text class="product-name">{{product.name}}</text>
      <view class="product-tags">
        <text class="tag tag-hot" wx:if="{{product.isHot}}">ğŸ”¥ çƒ­é”€</text>
        <text class="tag tag-new" wx:if="{{product.isNew}}">âœ¨ æ–°å“</text>
        <text class="tag tag-recommend" wx:if="{{product.isRecommend}}">ğŸ‘ æ¨è</text>
      </view>
    </view>
    
    <view class="product-meta">
      <view class="price-section">
        <text class="current-price">Â¥{{product.price}}</text>
        <text class="original-price" wx:if="{{product.originalPrice > product.price}}">
          Â¥{{product.originalPrice}}
        </text>
        <text class="discount" wx:if="{{product.discount}}">{{product.discount}}æŠ˜</text>
      </view>
      
      <view class="rating-section">
        <view class="rating-stars">
          <block wx:for="{{[1,2,3,4,5]}}" wx:key="index">
            <text class="iconfont {{index < Math.floor(product.rating) ? 'icon-star-fill' : 'icon-star'}}"></text>
          </block>
        </view>
        <text class="rating-text">{{product.rating}}åˆ†</text>
        <text class="sales-text">å·²å”®{{product.sales}}ä»¶</text>
      </view>
    </view>
    
    <view class="product-desc">
      <text>{{product.description}}</text>
    </view>
  </view>

  <!-- å®šåˆ¶åŒ–é€‰é¡¹ -->
  <view class="customization-section card">
    <view class="section-title">âš™ å®šåˆ¶ä½ çš„ä¸“å±é¥®å“</view>
    
    <!-- ç”œåº¦é€‰æ‹© -->
    <view class="customization-item">
      <view class="item-header">
        <text class="item-label">ç”œåº¦</text>
        <text class="item-required">å¿…é€‰</text>
      </view>
      <view class="option-group">
        <view 
          class="option-item {{customizations.sweetness === option.value ? 'selected' : ''}}" 
          wx:for="{{sweetnessOptions}}" 
          wx:key="value"
          bindtap="selectSweetness"
          data-value="{{option.value}}"
        >
          <text class="option-label">{{option.label}}</text>
          <text class="option-hint">{{option.hint}}</text>
        </view>
      </view>
    </view>

    <!-- æ¸©åº¦é€‰æ‹© -->
    <view class="customization-item">
      <view class="item-header">
        <text class="item-label">æ¸©åº¦</text>
        <text class="item-required">å¿…é€‰</text>
      </view>
      <view class="option-group">
        <view 
          class="option-item {{customizations.temperature === option.value ? 'selected' : ''}}" 
          wx:for="{{temperatureOptions}}" 
          wx:key="value"
          bindtap="selectTemperature"
          data-value="{{option.value}}"
        >
          <text class="option-label">{{option.label}}</text>
        </view>
      </view>
    </view>

    <!-- åŠ æ–™é€‰æ‹© -->
    <view class="customization-item">
      <view class="item-header">
        <text class="item-label">åŠ æ–™</text>
        <text class="item-hint">å¯é€‰ï¼Œæœ€å¤šé€‰æ‹©{{maxToppings}}ç§</text>
      </view>
      <view class="toppings-grid">
        <view 
          class="topping-item {{customizations.toppings.includes(topping.id) ? 'selected' : ''}}" 
          wx:for="{{toppingOptions}}" 
          wx:key="id"
          bindtap="toggleTopping"
          data-id="{{topping.id}}"
          data-price="{{topping.price}}"
        >
          <view class="topping-info">
            <image src="{{topping.icon}}" class="topping-icon"></image>
            <view class="topping-text">
              <text class="topping-name">{{topping.name}}</text>
              <text class="topping-price">+Â¥{{topping.price}}</text>
            </view>
          </view>
          <view class="topping-quantity" wx:if="{{customizations.toppings.includes(topping.id)}}">
            <text class="iconfont icon-check"></text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åŠ æ–™æ€»ä»· -->
    <view class="toppings-total" wx:if="{{toppingsCost > 0}}">
      <text>åŠ æ–™è´¹ç”¨ï¼š</text>
      <text class="toppings-price">+Â¥{{toppingsCost}}</text>
    </view>
  </view>

  <!-- å•†å“è¯¦æƒ… -->
  <view class="product-detail-section card">
    <view class="detail-tabs">
      <view 
        class="tab-item {{activeTab === 0 ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="0"
      >
        å•†å“è¯¦æƒ…
      </view>
      <view 
        class="tab-item {{activeTab === 1 ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="1"
      >
        è¥å…»æˆåˆ†
      </view>
      <view 
        class="tab-item {{activeTab === 2 ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="2"
      >
        ç”¨æˆ·è¯„ä»·({{product.commentCount || 0}})
      </view>
    </view>
    
    <view class="tab-content" wx:if="{{activeTab === 0}}">
      <rich-text nodes="{{product.detailHtml}}"></rich-text>
      <view class="ingredients" wx:if="{{product.ingredients && product.ingredients.length}}">
        <text class="ingredients-title">åŸæ–™æˆåˆ†ï¼š</text>
        <view class="ingredients-list">
          <text wx:for="{{product.ingredients}}" wx:key="index">{{item}}</text>
        </view>
      </view>
    </view>
    
    <view class="tab-content nutrition" wx:if="{{activeTab === 1}}">
      <view class="nutrition-table">
        <view class="nutrition-row header">
          <text>è¥å…»æˆåˆ†</text>
          <text>å«é‡(æ¯æ¯)</text>
        </view>
        <view class="nutrition-row" wx:for="{{product.nutrition}}" wx:key="name">
          <text class="nutrition-name">{{item.name}}</text>
          <text class="nutrition-value">{{item.value}}{{item.unit || ''}}</text>
        </view>
      </view>
      
      <view class="allergens" wx:if="{{product.allergens && product.allergens.length}}">
        <text class="allergens-title">è¿‡æ•åŸæç¤ºï¼š</text>
        <text class="allergens-content">{{product.allergens.join('ã€')}}</text>
      </view>
    </view>
    
    <view class="tab-content comments" wx:if="{{activeTab === 2}}">
      <view class="comment-summary">
        <view class="average-rating">
          <text class="rating-number">{{product.rating}}</text>
          <text class="rating-text">ç»¼åˆè¯„åˆ†</text>
        </view>
        <view class="rating-distribution">
          <view class="rating-item" wx:for="{{ratingDistribution}}" wx:key="index">
            <text>{{5 - index}}æ˜Ÿ</text>
            <view class="rating-bar">
              <view class="rating-fill" style="width: {{item.percentage}}%"></view>
            </view>
            <text>{{item.count}}æ¡</text>
          </view>
        </view>
      </view>
      
      <view class="comment-list">
        <view class="comment-item" wx:for="{{comments}}" wx:key="id">
          <view class="comment-header">
            <image src="{{item.userAvatar}}" class="user-avatar"></image>
            <view class="user-info">
              <text class="user-name">{{item.userName}}</text>
              <view class="comment-rating">
                <block wx:for="{{[1,2,3,4,5]}}" wx:key="index">
                  <text class="iconfont {{index < item.rating ? 'icon-star-fill' : 'icon-star'}}"></text>
                </block>
              </view>
            </view>
            <text class="comment-time">{{item.createTime}}</text>
          </view>
          <view class="comment-content">
            <text>{{item.content}}</text>
          </view>
          <view class="comment-images" wx:if="{{item.images && item.images.length}}">
            <scroll-view class="image-scroll" scroll-x="true">
              <view class="image-container">
                <image 
                  wx:for="{{item.images}}" 
                  wx:key="index"
                  src="{{item}}"
                  class="comment-image"
                  mode="aspectFill"
                  bindtap="previewImage"
                  data-url="{{item}}"
                  data-index="{{index}}"
                ></image>
              </view>
            </scroll-view>
          </view>
          <view class="comment-tags" wx:if="{{item.tags && item.tags.length}}">
            <text class="tag" wx:for="{{item.tags}}" wx:key="index">{{item}}</text>
          </view>
        </view>
      </view>
      
      <view class="load-more" wx:if="{{hasMoreComments}}" bindtap="loadMoreComments">
        <text>ç‚¹å‡»åŠ è½½æ›´å¤šè¯„ä»·</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-action-bar">
    <view class="bottom-left">
      <view class="cart-icon" bindtap="goToCart">
        <image class="cart-icon-img" src="/images/icons/cart.png"></image>
        <view class="cart-badge" wx:if="{{cartCount > 0}}">{{cartCount}}</view>
      </view>
      <view class="price-info">
        <text class="total-label">åˆè®¡ï¼š</text>
        <text class="total-price">Â¥{{totalPrice}}</text>
      </view>
    </view>
    
    <view class="bottom-right">
      <button 
        class="btn btn-secondary add-to-cart-btn" 
        bindtap="addToCart"
        wx:if="{{product.stock > 0}}"
      >
        <image class="btn-icon" src="/images/icons/add.png"></image>
        <text>åŠ å…¥è´­ç‰©è½¦</text>
      </button>
      <button 
        class="btn btn-primary buy-now-btn" 
        bindtap="buyNow"
        wx:if="{{product.stock > 0}}"
      >
        ç«‹å³è´­ä¹°
      </button>
      <view class="sold-out-btn" wx:if="{{product.stock <= 0}}">
        <text>å·²å”®ç½„</text>
      </view>
    </view>
  </view>
</view>