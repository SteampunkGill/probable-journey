<!--pages/order-detail/order-detail.wxml-->
<view class="order-detail-page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-icon"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- è®¢å•çŠ¶æ€ -->
    <view class="status-section">
      <view class="status-header">
        <text class="status-text">{{order.statusText}}</text>
        <text class="status-hint" wx:if="{{order.deliveryType === 'delivery'}}">é¢„è®¡{{order.estimatedTime}}é€è¾¾</text>
        <text class="status-hint" wx:if="{{order.deliveryType === 'pickup'}}">è¯·å‡­å–é¤ç å–é¤</text>
      </view>

      <!-- çŠ¶æ€æµç¨‹ -->
      <view class="status-steps">
        <view class="step {{index <= currentStep ? 'active' : ''}}" wx:for="{{statusSteps}}" wx:key="key">
          <view class="step-dot"></view>
          <text class="step-title">{{item.title}}</text>
          <text class="step-time" wx:if="{{item.time}}">{{item.time}}</text>
        </view>
      </view>
    </view>

    <!-- å–é¤ç ï¼ˆè‡ªå–è®¢å•ï¼‰ -->
    <view class="pickup-section" wx:if="{{order.deliveryType === 'pickup' && order.pickupCode}}">
      <view class="pickup-card">
        <text class="pickup-label">å–é¤ç </text>
        <text class="pickup-code">{{order.pickupCode}}</text>
        <button class="copy-btn" bindtap="copyPickupCode">å¤åˆ¶</button>
      </view>
    </view>

    <!-- é—¨åº—/åœ°å€ä¿¡æ¯ -->
    <view class="location-section">
      <view class="section-title">
        {{order.deliveryType === 'delivery' ? 'æ”¶è´§ä¿¡æ¯' : 'è‡ªæé—¨åº—'}}
      </view>
      
      <!-- é…é€åœ°å€ -->
      <view class="address-card" wx:if="{{order.deliveryType === 'delivery' && order.address}}">
        <view class="address-header">
          <text class="name">{{order.address.name}}</text>
          <text class="phone">{{order.address.phone}}</text>
        </view>
        <text class="address-detail">{{order.address.fullAddress}}</text>
      </view>

      <!-- è‡ªæé—¨åº— -->
      <view class="store-card" wx:if="{{order.deliveryType === 'pickup' && order.store}}">
        <view class="store-header">
          <text class="store-name">{{order.store.name}}</text>
          <button class="call-btn" bindtap="callStore">
            <text class="icon">ğŸ“</text>
            <text>è”ç³»é—¨åº—</text>
          </button>
        </view>
        <text class="store-address">{{order.store.address}}</text>
        <text class="store-hours">è¥ä¸šæ—¶é—´ï¼š{{order.store.businessHours}}</text>
      </view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="goods-section">
      <view class="section-title">å•†å“æ¸…å•</view>
      <view class="goods-list">
        <view class="goods-item" wx:for="{{order.items}}" wx:key="id">
          <image class="goods-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="goods-info">
            <text class="goods-name">{{item.name}}</text>
            <view class="goods-specs" wx:if="{{item.customizations}}">
              <text>{{item.customizations.sweetness}} / {{item.customizations.temperature}}</text>
              <text wx:if="{{item.customizations.toppings.length > 0}}">
                + {{item.customizations.toppings.length}}ç§åŠ æ–™
              </text>
            </view>
            <view class="goods-bottom">
              <text class="goods-price">Â¥{{item.price}}</text>
              <text class="goods-quantity">Ã—{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢å•ä¿¡æ¯ -->
    <view class="info-section">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="info-list">
        <view class="info-item">
          <text class="label">è®¢å•ç¼–å·</text>
          <view class="value-copy">
            <text class="value">{{order.orderNo}}</text>
            <button class="copy-icon" bindtap="copyOrderNo">å¤åˆ¶</button>
          </view>
        </view>
        <view class="info-item">
          <text class="label">ä¸‹å•æ—¶é—´</text>
          <text class="value">{{order.createTime}}</text>
        </view>
        <view class="info-item" wx:if="{{order.payTime}}">
          <text class="label">æ”¯ä»˜æ—¶é—´</text>
          <text class="value">{{order.payTime}}</text>
        </view>
        <view class="info-item">
          <text class="label">æ”¯ä»˜æ–¹å¼</text>
          <text class="value">{{order.paymentMethodText}}</text>
        </view>
        <view class="info-item" wx:if="{{order.remark}}">
          <text class="label">è®¢å•å¤‡æ³¨</text>
          <text class="value">{{order.remark}}</text>
        </view>
      </view>
    </view>

    <!-- è´¹ç”¨æ˜ç»† -->
    <view class="amount-section">
      <view class="section-title">è´¹ç”¨æ˜ç»†</view>
      <view class="amount-list">
        <view class="amount-item">
          <text class="label">å•†å“å°è®¡</text>
          <text class="value">Â¥{{order.subtotal}}</text>
        </view>
        <view class="amount-item" wx:if="{{order.deliveryFee > 0}}">
          <text class="label">é…é€è´¹</text>
          <text class="value">Â¥{{order.deliveryFee}}</text>
        </view>
        <view class="amount-item" wx:if="{{order.packagingFee > 0}}">
          <text class="label">åŒ…è£…è´¹</text>
          <text class="value">Â¥{{order.packagingFee}}</text>
        </view>
        <view class="amount-item discount" wx:if="{{order.couponDiscount > 0}}">
          <text class="label">ä¼˜æƒ åˆ¸ä¼˜æƒ </text>
          <text class="value">-Â¥{{order.couponDiscount}}</text>
        </view>
        <view class="amount-item discount" wx:if="{{order.pointsDiscount > 0}}">
          <text class="label">ç§¯åˆ†æŠµæ‰£</text>
          <text class="value">-Â¥{{order.pointsDiscount}}</text>
        </view>
        <view class="amount-item total">
          <text class="label">å®ä»˜æ¬¾</text>
          <text class="value">Â¥{{order.totalAmount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="footer" wx:if="{{!loading}}">
    <!-- å¾…æ”¯ä»˜ -->
    <block wx:if="{{order.canPay}}">
      <button class="footer-btn secondary" bindtap="cancelOrder">å–æ¶ˆè®¢å•</button>
      <button class="footer-btn primary" bindtap="payOrder">ç«‹å³æ”¯ä»˜</button>
    </block>

    <!-- åˆ¶ä½œä¸­ -->
    <block wx:elif="{{order.canRemind}}">
      <button class="footer-btn secondary" bindtap="contactService">è”ç³»å®¢æœ</button>
      <button class="footer-btn primary" bindtap="remindOrder">å‚¬å•</button>
    </block>

    <!-- å¾…ç¡®è®¤ -->
    <block wx:elif="{{order.canConfirm}}">
      <button class="footer-btn secondary" bindtap="contactService">è”ç³»å®¢æœ</button>
      <button class="footer-btn primary" bindtap="confirmOrder">ç¡®è®¤æ”¶è´§</button>
    </block>

    <!-- å·²å®Œæˆ -->
    <block wx:elif="{{order.canReview}}">
      <button class="footer-btn secondary" bindtap="reorder">å†æ¥ä¸€å•</button>
      <button class="footer-btn primary" bindtap="reviewOrder">å»è¯„ä»·</button>
    </block>

    <!-- å…¶ä»–çŠ¶æ€ -->
    <block wx:else>
      <button class="footer-btn secondary" bindtap="contactService">è”ç³»å®¢æœ</button>
      <button class="footer-btn primary" bindtap="reorder">å†æ¥ä¸€å•</button>
    </block>
  </view>
</view>
