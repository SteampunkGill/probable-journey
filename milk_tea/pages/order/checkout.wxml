<!--pages/order/checkout.wxml-->
<view class="checkout-page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-icon"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- é…é€æ–¹å¼ -->
    <view class="section delivery-type">
      <view class="type-tabs">
        <view class="tab {{deliveryType === 'delivery' ? 'active' : ''}}" bindtap="switchDeliveryType" data-type="delivery">
          <text class="icon">ğŸšš</text>
          <text>å¤–å–é…é€</text>
        </view>
        <view class="tab {{deliveryType === 'pickup' ? 'active' : ''}}" bindtap="switchDeliveryType" data-type="pickup">
          <text class="icon">ğŸª</text>
          <text>åˆ°åº—è‡ªå–</text>
        </view>
      </view>
    </view>

    <!-- æ”¶è´§åœ°å€ -->
    <view class="section address-section" wx:if="{{deliveryType === 'delivery'}}" bindtap="selectAddress">
      <view class="address-card" wx:if="{{selectedAddress}}">
        <view class="address-header">
          <text class="name">{{selectedAddress.name}}</text>
          <text class="phone">{{selectedAddress.phone}}</text>
        </view>
        <view class="address-detail">
          <text class="icon">ğŸ“</text>
          <text class="text">{{selectedAddress.province}} {{selectedAddress.city}} {{selectedAddress.district}} {{selectedAddress.detail}}</text>
        </view>
      </view>
      <view class="address-empty" wx:else>
        <text class="icon">â•</text>
        <text>è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
      </view>
      <text class="arrow">â€º</text>
    </view>

    <!-- è‡ªæé—¨åº— -->
    <view class="section store-section" wx:if="{{deliveryType === 'pickup'}}" bindtap="selectStore">
      <view class="store-card" wx:if="{{selectedStore}}">
        <view class="store-name">{{selectedStore.name}}</view>
        <view class="store-address">{{selectedStore.address}}</view>
        <view class="store-time">è¥ä¸šæ—¶é—´ï¼š{{selectedStore.businessHours}}</view>
      </view>
      <view class="store-empty" wx:else>
        <text class="icon">ğŸª</text>
        <text>è¯·é€‰æ‹©è‡ªæé—¨åº—</text>
      </view>
      <text class="arrow">â€º</text>
    </view>

    <!-- é¢„è®¡é€è¾¾æ—¶é—´ -->
    <view class="section time-section" wx:if="{{deliveryType === 'delivery'}}">
      <text class="label">â° é¢„è®¡é€è¾¾</text>
      <text class="time">{{estimatedDeliveryTime}}</text>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="section goods-section">
      <view class="section-title">è®¢å•å•†å“</view>
      <view class="goods-list">
        <view class="goods-item" wx:for="{{orderItems}}" wx:key="id">
          <image class="goods-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="goods-info">
            <view class="goods-name">{{item.name}}</view>
            <view class="goods-specs" wx:if="{{item.customizations}}">
              <text>{{item.customizations.sweetness}} / {{item.customizations.temperature}}</text>
              <text wx:if="{{item.customizations.toppings.length > 0}}"> + {{item.customizations.toppings.length}}ç§åŠ æ–™</text>
            </view>
            <view class="goods-price">
              <text class="price">Â¥{{item.price}}</text>
              <text class="quantity">Ã—{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼˜æƒ åˆ¸ -->
    <view class="section coupon-section" bindtap="selectCoupon">
      <text class="label">ğŸ« ä¼˜æƒ åˆ¸</text>
      <view class="value">
        <text wx:if="{{selectedCoupon}}">{{selectedCoupon.name}}</text>
        <text wx:else class="placeholder">è¯·é€‰æ‹©ä¼˜æƒ åˆ¸</text>
        <text class="count" wx:if="{{availableCoupons.length > 0}}">{{availableCoupons.length}}å¼ å¯ç”¨</text>
      </view>
      <text class="arrow">â€º</text>
    </view>

    <!-- ç§¯åˆ†æŠµæ‰£ -->
    <view class="section points-section">
      <view class="points-header">
        <text class="label">ğŸ’ ç§¯åˆ†æŠµæ‰£</text>
        <switch checked="{{usePoints}}" bindchange="toggleUsePoints" color="#D4A574" />
      </view>
      <view class="points-input" wx:if="{{usePoints}}">
        <text>ä½¿ç”¨</text>
        <input type="number" value="{{pointsToUse}}" bindinput="onPointsInput" placeholder="0" />
        <text>ç§¯åˆ†ï¼ˆå¯ç”¨{{availablePoints}}ï¼‰</text>
      </view>
    </view>

    <!-- å¤‡æ³¨ -->
    <view class="section remark-section">
      <view class="remark-label">ğŸ’¬ è®¢å•å¤‡æ³¨</view>
      <textarea 
        class="remark-input" 
        placeholder="å£å‘³ã€åå¥½ç­‰è¦æ±‚" 
        value="{{remark}}"
        bindinput="onRemarkInput"
        maxlength="100"
      ></textarea>
    </view>

    <!-- é¤å…· -->
    <view class="section tableware-section">
      <text class="label">ğŸ´ é¤å…·æ•°é‡</text>
      <input class="tableware-input" type="number" value="{{tablewareCount}}" bindchange="onTablewareChange" />
      <text class="unit">ä»½</text>
    </view>

    <!-- è´¹ç”¨æ˜ç»† -->
    <view class="section amount-section">
      <view class="section-title">è´¹ç”¨æ˜ç»†</view>
      <view class="amount-list">
        <view class="amount-item">
          <text class="label">å•†å“å°è®¡</text>
          <text class="value">Â¥{{subtotal}}</text>
        </view>
        <view class="amount-item" wx:if="{{deliveryType === 'delivery'}}">
          <text class="label">é…é€è´¹</text>
          <text class="value">Â¥{{deliveryFee}}</text>
        </view>
        <view class="amount-item">
          <text class="label">åŒ…è£…è´¹</text>
          <text class="value">Â¥{{packagingFee}}</text>
        </view>
        <view class="amount-item discount" wx:if="{{couponDiscount > 0}}">
          <text class="label">ä¼˜æƒ åˆ¸ä¼˜æƒ </text>
          <text class="value">-Â¥{{couponDiscount}}</text>
        </view>
        <view class="amount-item discount" wx:if="{{pointsDiscount > 0}}">
          <text class="label">ç§¯åˆ†æŠµæ‰£</text>
          <text class="value">-Â¥{{pointsDiscount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æäº¤æ  -->
  <view class="footer">
    <view class="total-amount">
      <text class="label">å®ä»˜æ¬¾ï¼š</text>
      <text class="amount">Â¥{{totalAmount}}</text>
    </view>
    <button class="submit-btn {{submitting ? 'disabled' : ''}}" bindtap="submitOrder" disabled="{{submitting}}">
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤è®¢å•'}}
    </button>
  </view>
</view>
