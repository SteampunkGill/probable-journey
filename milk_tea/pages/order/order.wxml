<!--pages/order/order.wxml-->
<view class="order-page">
  <!-- 顶部搜索栏 -->
  <view class="search-bar">
    <view class="search-input" hover-class="search-input-hover">
      <image class="search-icon" src="/images/icons/search.png"></image>
      <input
        type="text"
        placeholder="搜索饮品..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
        confirm-type="search"
        placeholder-class="search-placeholder"
      />
      <image
        class="clear-icon"
        src="/images/icons/close.png"
        wx:if="{{searchKeyword}}"
        bindtap="clearSearch"
      ></image>
    </view>
    <view class="filter-btn" bindtap="toggleFilterPanel">
      <image class="filter-icon" src="/images/icons/edit.png"></image>
  <!-- 筛选面板 -->
  <view class="filter-panel {{showFilterPanel ? 'show' : ''}}" wx:if="{{showFilterPanel}}">
    <view class="filter-mask" bindtap="toggleFilterPanel"></view>
    <view class="filter-content animate-slide-right">
      <view class="filter-header">
        <text class="filter-title">商品筛选</text>
        <text class="filter-reset" bindtap="resetFilters">重置</text>
      </view>
      <scroll-view class="filter-body" scroll-y>
        <!-- 热度筛选 -->
        <view class="filter-group">
          <view class="group-title">热度</view>
          <view class="option-grid">
            <view 
              class="option-item {{activeFilters.hot === item.value ? 'active' : ''}}"
              wx:for="{{filterOptions[0].options}}"
              wx:key="value"
              bindtap="selectFilterOption"
              data-type="hot"
              data-value="{{item.value}}"
            >{{item.label}}</view>
          </view>
        </view>

        <!-- 价格筛选 -->
        <view class="filter-group">
          <view class="group-title">价格</view>
          <view class="option-grid">
            <view 
              class="option-item {{activeFilters.price === item.value ? 'active' : ''}}"
              wx:for="{{filterOptions[1].options}}"
              wx:key="value"
              bindtap="selectFilterOption"
              data-type="price"
              data-value="{{item.value}}"
            >{{item.label}}</view>
          </view>
        </view>

        <!-- 糖度筛选 -->
        <view class="filter-group">
          <view class="group-title">糖度</view>
          <view class="option-grid">
            <view 
              class="option-item {{activeFilters.sweetness === item ? 'active' : ''}}"
              wx:for="{{sweetnessOptions}}"
              wx:key="*this"
              bindtap="selectFilterOption"
              data-type="sweetness"
              data-value="{{item}}"
            >{{item}}</view>
          </view>
        </view>
      </scroll-view>
      <view class="filter-footer">
        <button class="cancel-btn" bindtap="toggleFilterPanel">取消</button>
        <button class="confirm-btn" bindtap="confirmFilters">确定</button>
      </view>
    </view>
  </view>

      <text>筛选</text>
    </view>
  </view>

  <!-- 主体内容区 -->
  <view class="content-wrapper">
    <!-- 左侧分类栏 -->
    <scroll-view class="category-sidebar" scroll-y scroll-with-animation>
      <view 
        class="category-item {{activeCategoryId === item.id ? 'active' : ''}}"
        wx:for="{{categories}}"
        wx:key="id"
        bindtap="selectCategory"
        data-id="{{item.id}}"
        hover-class="category-item-hover"
      >
        <text class="category-icon">{{item.icon}}</text>
        <text class="category-name">{{item.name}}</text>
        <view class="active-indicator" wx:if="{{activeCategoryId === item.id}}"></view>
      </view>
    </scroll-view>

    <!-- 右侧商品列表 -->
    <scroll-view 
      class="product-section" 
      scroll-y
      scroll-with-animation
      lower-threshold="100"
      bindscrolltolower="loadMore"
    >
      <!-- 骨架屏 -->
      <view class="skeleton-list" wx:if="{{loading && productList.length === 0}}">
        <view class="skeleton-product" wx:for="{{[1,2,3,4,5]}}" wx:key="*this"></view>
      </view>

      <view class="product-list" wx:else>
        <view 
          class="product-card {{item.animating ? 'bounce' : ''}}"
          wx:for="{{productList}}"
          wx:key="id"
          bindtap="onProductTap"
          data-id="{{item.id}}"
          hover-class="product-card-hover"
        >
          <!-- 左侧图片 -->
          <view class="product-image-wrapper">
            <image class="product-image" src="{{item.image}}" mode="aspectFill" lazy-load></image>
            <view class="tag hot" wx:if="{{item.hot}}">热销</view>
            <view class="tag discount" wx:if="{{item.originalPrice}}">折扣</view>
            <!-- 收藏按钮 -->
            <view 
              class="favorite-btn {{item.isFavorite ? 'active' : ''}}"
              bindtap="toggleFavorite"
              catchtap="toggleFavorite"
              data-id="{{item.id}}"
              hover-class="favorite-btn-hover"
            >
              <image 
                class="favorite-icon"
                src="{{item.isFavorite ? '/images/icons/heart-fill.png' : '/images/icons/heart.png'}}"
              ></image>
            </view>
          </view>

          <!-- 右侧信息 -->
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <text class="product-desc">{{item.description}}</text>
            
            <view class="product-footer">
              <view class="price-box">
                <text class="price">¥{{item.price}}</text>
                <text class="original-price" wx:if="{{item.originalPrice}}">¥{{item.originalPrice}}</text>
              </view>
              <text class="sales">已售{{item.sales}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 加载更多 -->
      <view class="loading-more" wx:if="{{loading && productList.length > 0}}">
        <view class="loading-spinner"></view>
        <text>加载中...</text>
      </view>

      <!-- 空状态 -->
      <view class="empty-tip" wx:if="{{!loading && productList.length === 0}}">
        <image class="empty-icon" src="/images/icons/cart.png"></image>
        <text>暂无商品</text>
      </view>
    </scroll-view>
  </view>

  <!-- 购物车浮动按钮 -->
  <view class="cart-float {{cartCount > 0 ? 'show' : ''}}" bindtap="goToCart" hover-class="cart-float-hover">
    <image class="cart-icon" src="/images/icons/cart.png"></image>
    <view class="cart-badge {{cartAnimating ? 'bounce' : ''}}">{{cartCount}}</view>
    <view class="cart-ripple"></view>
  </view>
  <!-- 定制弹窗 -->
  <view class="custom-modal {{showCustomModal ? 'show' : ''}}" catchtouchmove="preventTouchMove" wx:if="{{showCustomModal}}">
    <view class="modal-mask" bindtap="hideModal" catchtouchmove="preventTouchMove"></view>
    <view class="modal-content animate-slide-up">
      <!-- 商品信息 -->
      <view class="modal-header">
        <image class="modal-image" src="{{selectedProduct.image}}" mode="aspectFill"></image>
        <view class="modal-info">
          <text class="modal-name">{{selectedProduct.name}}</text>
          <text class="modal-price">¥{{totalPrice}}</text>
        </view>
        <view class="close-btn" bindtap="hideModal" hover-class="close-btn-hover">
          <image class="close-icon" src="/images/icons/close.png"></image>
        </view>
      </view>

      <scroll-view class="modal-body" scroll-y>
        <!-- 杯型选择 -->
        <view class="option-group">
          <text class="option-title">杯型</text>
          <view class="option-list">
            <view 
              class="option-item {{customizations.size === item ? 'active' : ''}}"
              wx:for="{{sizeOptions}}"
              wx:key="*this"
              bindtap="selectSize"
              data-size="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>

        <!-- 温度选择 -->
        <view class="option-group">
          <text class="option-title">温度</text>
          <view class="option-list">
            <view 
              class="option-item {{customizations.temperature === item ? 'active' : ''}}"
              wx:for="{{temperatureOptions}}"
              wx:key="*this"
              bindtap="selectTemperature"
              data-temp="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>

        <!-- 甜度选择 -->
        <view class="option-group">
          <text class="option-title">甜度</text>
          <view class="option-list">
            <view 
              class="option-item {{customizations.sweetness === item ? 'active' : ''}}"
              wx:for="{{sweetnessOptions}}"
              wx:key="*this"
              bindtap="selectSweetness"
              data-sweet="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>

        <!-- 冰度选择 -->
        <view class="option-group" wx:if="{{customizations.temperature !== '热饮'}}">
          <text class="option-title">冰度</text>
          <view class="option-list">
            <view 
              class="option-item {{customizations.ice === item ? 'active' : ''}}"
              wx:for="{{iceOptions}}"
              wx:key="*this"
              bindtap="selectIce"
              data-ice="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>

        <!-- 加料选择 -->
        <view class="option-group">
          <text class="option-title">加料（可多选）</text>
          <view class="option-list">
            <view 
              class="option-item topping {{customizations.toppings.indexOf(item.id) > -1 ? 'active' : ''}}"
              wx:for="{{toppingOptions}}"
              wx:key="id"
              bindtap="toggleTopping"
              data-id="{{item.id}}"
            >
              <text>{{item.name}}</text>
              <text class="topping-price">+¥{{item.price}}</text>
            </view>
          </view>
        </view>

        <!-- 数量选择 -->
        <view class="option-group">
          <text class="option-title">数量</text>
          <view class="quantity-control">
            <view 
              class="quantity-btn {{quantity <= 1 ? 'disabled' : ''}}" 
              bindtap="decreaseQuantity"
              hover-class="{{quantity > 1 ? 'quantity-btn-hover' : ''}}"
            >-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view 
              class="quantity-btn" 
              bindtap="increaseQuantity"
              hover-class="quantity-btn-hover"
            >+</view>
          </view>
        </view>
      </scroll-view>

      <!-- 底部操作栏 -->
      <view class="modal-footer">
        <view class="total-price">
          <text class="total-label">合计</text>
          <text class="total-value">￥{{totalPrice}}</text>
        </view>
        <button class="confirm-btn" bindtap="confirmAddToCart" hover-class="confirm-btn-hover">
          加入购物车
        </button>
      </view>
    </view>
  </view>
</view>
