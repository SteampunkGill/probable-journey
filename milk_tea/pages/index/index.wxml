<!--pages/index/index.wxml-->
<view class="page-container">
  <!-- 顶部搜索栏 -->
  <view class="search-bar {{scrollTop > 50 ? 'shadow' : ''}}">
    <view class="search-box" bindtap="goToSearch" hover-class="search-box-hover">
      <image class="search-icon" src="/images/icons/search.png"></image>
      <text class="search-placeholder">搜索饮品、门店...</text>
    </view>
    <image class="scan-btn" src="/images/icons/scan.png" bindtap="goToScan" hover-class="scan-btn-hover"></image>
  </view>

  <!-- 骨架屏加载 -->
  <view class="skeleton-container" wx:if="{{loading}}">
    <view class="skeleton-banner"></view>
    <view class="skeleton-mode">
      <view class="skeleton-mode-item"></view>
      <view class="skeleton-mode-item"></view>
    </view>
    <view class="skeleton-menu">
      <view class="skeleton-menu-item" wx:for="{{[1,2,3,4]}}" wx:key="*this"></view>
    </view>
    <view class="skeleton-products">
      <view class="skeleton-product" wx:for="{{[1,2,3]}}" wx:key="*this"></view>
    </view>
  </view>

  <scroll-view 
    class="main-content" 
    scroll-y
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onRefresh"
    bindscroll="onScroll"
    wx:else>
    <!-- 轮播图 -->
    <swiper 
      class="banner-swiper animate-fade-in" 
      indicator-dots="{{true}}" 
      autoplay="{{true}}" 
      interval="5000"
      duration="500"
      circular="{{true}}"
      indicator-color="rgba(255,255,255,0.5)"
      indicator-active-color="#D4A574"
      easing-function="easeInOutCubic"
    >
      <block wx:for="{{banners}}" wx:key="id">
        <swiper-item>
          <image 
            src="{{item.image}}" 
            class="banner-image" 
            mode="aspectFill"
            lazy-load="{{true}}"
          ></image>
          <view class="banner-overlay">
            <text class="banner-title">{{item.title}}</text>
          </view>
        </swiper-item>
      </block>
    </swiper>

    <!-- 门店选择组件 -->
    <view class="store-selector-section animate-fade-in">
      <view class="current-store" bindtap="goToStoreList">
        <view class="store-main">
          <image class="location-icon" src="/images/icons/address.png"></image>
          <view class="store-name-wrapper">
            <text class="store-name">{{selectedStore.name || '正在定位...'}}</text>
            <text class="store-distance" wx:if="{{selectedStore.distance}}">距您 {{selectedStore.distance}}km</text>
          </view>
          <image class="arrow-icon" src="/images/icons/right.png"></image>
        </view>
        <view class="store-address-text">{{selectedStore.address || '请选择门店'}}</view>
      </view>
      <view class="location-action" bindtap="reLocation">
        <image class="re-location-icon {{isLocating ? 'rotating' : ''}}" src="/images/icons/history.png"></image>
        <text>重新定位</text>
      </view>
    </view>

    <!-- 点餐方式选择 -->
    <view class="order-mode-section">
      <view class="mode-title">选择点餐方式</view>
      <view class="mode-buttons">
        <view class="mode-card delivery" bindtap="selectOrderMode" data-mode="delivery">
          <image class="mode-icon" src="/images/icons/order.png"></image>
          <view class="mode-info">
            <text class="mode-name">外卖配送</text>
            <text class="mode-desc">30分钟送达</text>
          </view>
        </view>
        
        <view class="mode-card pickup" bindtap="selectOrderMode" data-mode="pickup">
          <image class="mode-icon" src="/images/icons/pick_up_food.png"></image>
          <view class="mode-info">
            <text class="mode-name">到店自取</text>
            <text class="mode-desc">预计制作时间</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 快捷入口 -->
    <view class="quick-menu animate-slide-up">
      <view class="menu-item" bindtap="goToOrder" hover-class="menu-item-hover">
        <view class="menu-icon-wrapper">
          <image class="menu-icon" src="/images/icons/order.png"></image>
        </view>
        <text class="menu-name">点单</text>
      </view>
      <view class="menu-item" bindtap="goToPickup" hover-class="menu-item-hover">
        <view class="menu-icon-wrapper">
          <image class="menu-icon" src="/images/icons/pick_up_food.png"></image>
        </view>
        <text class="menu-name">取餐</text>
      </view>
      <view class="menu-item" bindtap="goToCoupon" hover-class="menu-item-hover">
        <view class="menu-icon-wrapper">
          <image class="menu-icon" src="/images/icons/coupon.png"></image>
          <view class="coupon-badge" wx:if="{{availableCouponCount > 0}}">{{availableCouponCount}}</view>
        </view>
        <text class="menu-name">优惠券</text>
      </view>
      <view class="menu-item" bindtap="goToWallet" hover-class="menu-item-hover">
        <view class="menu-icon-wrapper">
          <image class="menu-icon" src="/images/icons/gift.png"></image>
        </view>
        <text class="menu-name">钱包</text>
      </view>
    </view>

    <!-- 推荐商品 -->
    <view class="section" wx:if="{{recommendProducts.length > 0}}">
      <view class="section-header">
        <text class="section-title">为你推荐</text>
        <view class="section-more" bindtap="goToRecommend">
          <text>更多</text>
          <image class="arrow-icon" src="/images/icons/right.png"></image>
        </view>
      </view>
      
      <scroll-view class="recommend-scroll" scroll-x>
        <view class="recommend-list">
          <view 
            class="recommend-item" 
            wx:for="{{recommendProducts}}" 
            wx:key="id"
            bindtap="onProductTap"
            data-id="{{item.id}}"
          >
            <image src="{{item.image}}" class="recommend-image" mode="aspectFill"></image>
            <view class="recommend-info">
              <text class="recommend-name">{{item.name}}</text>
              <view class="recommend-bottom">
                <text class="recommend-price">¥{{item.price}}</text>
                <image class="add-icon" src="/images/icons/add.png" bindtap="quickAdd" catchtap="stopPropagation" data-id="{{item.id}}"></image>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 今日热门 -->
    <view class="section" wx:if="{{hotProducts.length > 0}}">
      <view class="section-header">
        <text class="section-title">今日热门</text>
        <view class="section-more" bindtap="goToHot">
          <text>更多</text>
          <image class="arrow-icon" src="/images/icons/right.png"></image>
        </view>
      </view>
      
      <view class="hot-list">
        <view 
          class="hot-item" 
          wx:for="{{hotProducts}}" 
          wx:key="id"
          bindtap="onProductTap"
          data-id="{{item.id}}"
        >
          <image src="{{item.image}}" class="hot-image" mode="aspectFill"></image>
          <view class="hot-info">
            <text class="hot-name">{{item.name}}</text>
            <text class="hot-desc">{{item.description}}</text>
            <view class="hot-bottom">
              <view class="hot-meta">
                <text class="hot-price">¥{{item.price}}</text>
                <text class="hot-sales">已售{{item.sales}}</text>
              </view>
              <image class="add-icon" src="/images/icons/add.png" bindtap="quickAdd" catchtap="stopPropagation" data-id="{{item.id}}"></image>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 促销活动 -->
    <view class="section" wx:if="{{promotions.length > 0}}">
      <view class="section-header">
        <text class="section-title">优惠活动</text>
        <view class="section-more" bindtap="goToPromotions">
          <text>更多</text>
          <image class="arrow-icon" src="/images/icons/right.png"></image>
        </view>
      </view>
      
      <view class="promotion-list">
        <view 
          class="promotion-item" 
          wx:for="{{promotions}}" 
          wx:key="id"
          bindtap="onPromotionTap"
          data-id="{{item.id}}"
        >
          <image class="promotion-icon" src="/images/icons/gift.png"></image>
          <view class="promotion-info">
            <text class="promotion-title">{{item.title}}</text>
            <text class="promotion-desc">{{item.description}}</text>
          </view>
          <image class="promotion-arrow" src="/images/icons/right.png"></image>
        </view>
      </view>
    </view>

    <!-- 附近门店 -->
    <view class="section" wx:if="{{nearbyStore}}">
      <view class="section-header">
        <text class="section-title">附近门店</text>
        <view class="section-more" bindtap="goToStores">
          <text>更多</text>
          <image class="arrow-icon" src="/images/icons/right.png"></image>
        </view>
      </view>
      
      <view class="store-card">
        <view class="store-header">
          <text class="store-name">{{nearbyStore.name}}</text>
          <view class="store-status open">营业中</view>
        </view>
        <view class="store-info">
          <image class="info-icon" src="/images/icons/address.png"></image>
          <text class="store-address">{{nearbyStore.address}}</text>
        </view>
        <view class="store-info">
          <image class="info-icon" src="/images/icons/info.png"></image>
          <text class="store-hours">{{nearbyStore.businessHours}}</text>
        </view>
        <view class="store-footer">
          <text class="store-distance">距您 {{nearbyStore.distance}}</text>
          <view class="store-call" bindtap="callStore">
            <image class="call-icon" src="/images/icons/phone.png"></image>
            <text>联系门店</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部占位 -->
    <view class="bottom-space"></view>
  </scroll-view>
  
  <!-- 购物车浮动按钮 -->
  <view class="cart-float {{cartCount > 0 ? 'show' : ''}}" bindtap="goToCart" hover-class="cart-float-hover">
    <image class="cart-icon" src="/images/icons/cart.png"></image>
    <view class="cart-badge {{cartAnimating ? 'bounce' : ''}}">{{cartCount}}</view>
    <view class="cart-ripple"></view>
  </view>
</view>
