<view class="review-page">
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text>加载中...</text>
  </view>

  <view wx:elif="{{order}}" class="content">
    <!-- 商品简要信息 -->
    <view class="order-card card">
      <view class="goods-list">
        <view class="goods-item" wx:for="{{order.items}}" wx:key="id">
          <image src="{{item.image}}" class="goods-image" mode="aspectFill" />
          <view class="goods-info">
            <text class="goods-name">{{ item.name }}</text>
            <text class="goods-specs" wx:if="{{item.customizations}}">
              {{ item.customizations.sweetness }} / {{ item.customizations.temperature }}
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- 评分区域 -->
    <view class="rating-card card">
      <view class="rating-item">
        <view class="section-title">商品评价</view>
        <view class="stars">
          <text
            wx:for="{{[1, 2, 3, 4, 5]}}"
            wx:key="*this"
            class="star {{item <= productScore ? 'active' : ''}}"
            bindtap="setProductScore"
            data-score="{{item}}"
          >{{ item <= productScore ? '⭐' : '☆' }}</text>
          <text class="score-text">{{ productScoreText }}</text>
        </view>
      </view>

      <view class="rating-item" style="margin-top: 40rpx;">
        <view class="section-title">配送评价</view>
        <view class="stars">
          <text
            wx:for="{{[1, 2, 3, 4, 5]}}"
            wx:key="*this"
            class="star {{item <= deliveryScore ? 'active' : ''}}"
            bindtap="setDeliveryScore"
            data-score="{{item}}"
          >{{ item <= deliveryScore ? '⭐' : '☆' }}</text>
          <text class="score-text">{{ deliveryScoreText }}</text>
        </view>
      </view>
    </view>

    <!-- 评价内容 -->
    <view class="content-card card">
      <textarea 
        value="{{content}}" 
        placeholder="分享你的饮用体验，帮助更多小伙伴~" 
        maxlength="200"
        bindinput="onContentInput"
      ></textarea>
      <view class="word-count">{{ content.length }}/200</view>
    </view>

    <!-- 图片上传 -->
    <view class="image-card card">
      <view class="section-title">上传图片</view>
      <view class="image-list">
        <view class="image-item" wx:for="{{images}}" wx:key="*this" bindtap="previewImage" data-url="{{item}}">
          <image src="{{item}}" mode="aspectFill" />
          <view class="delete-btn" catchtap="removeImage" data-index="{{index}}">×</view>
        </view>
        <view class="upload-btn" wx:if="{{images.length < 4}}" bindtap="chooseImage">
          <text class="plus">+</text>
          <text class="text">添加图片</text>
        </view>
      </view>
    </view>

    <!-- 匿名选项 -->
    <view class="anonymous-card card">
      <label class="checkbox-label" bindtap="toggleAnonymous">
        <checkbox checked="{{isAnonymous}}" color="#a0522d" />
        <text>匿名评价</text>
      </label>
    </view>

    <button class="submit-btn" disabled="{{submitting}}" bindtap="submitReview">
      {{ submitting ? '提交中...' : '发布评价' }}
    </button>

    <!-- 申诉按钮 -->
    <view class="appeal-section" wx:if="{{order.status === 'REVIEWED' || order.status === 'COMPLETED'}}">
      <button class="appeal-btn" bindtap="showAppeal">申请退款/申诉</button>
    </view>
  </view>
</view>

<!-- 申诉弹窗 -->
<view class="modal-mask" wx:if="{{showAppealModal}}">
  <view class="modal-container">
    <view class="modal-header">
      <text>申请退款</text>
      <text class="close" bindtap="hideAppeal">×</text>
    </view>
    <view class="modal-body">
      <view class="form-item">
        <text class="label">退款原因</text>
        <picker bindchange="onAppealReasonChange" value="{{appealReasonIndex}}" range="{{appealReasons}}">
          <view class="picker-value">{{ appealReasons[appealReasonIndex] }}</view>
        </picker>
      </view>
      <view class="form-item">
        <text class="label">详细描述</text>
        <textarea value="{{appealDescription}}" placeholder="请详细描述您的问题..." bindinput="onAppealDescriptionInput"></textarea>
      </view>
      <view class="form-item">
        <text class="label">退款金额</text>
        <view class="amount">¥{{ order.totalAmount }}</view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="cancel-btn" bindtap="hideAppeal">取消</button>
      <button class="confirm-btn" disabled="{{appealing}}" bindtap="submitAppeal">
        {{ appealing ? '提交中...' : '提交申请' }}
      </button>
    </view>
  </view>
</view>