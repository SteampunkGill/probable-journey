<view class="order-manage">
  <view class="action-bar card">
    <view class="search-form">
      <input class="admin-input" placeholder="订单号" value="{{query.orderNo}}" bindinput="onOrderNoInput" />
      <picker bindchange="onFrontendStatusChange" value="{{frontendStatusIndex}}" range="{{statusOptions}}">
        <view class="admin-select">{{statusOptions[frontendStatusIndex]}}</view>
      </picker>
      <button class="btn-primary" bindtap="loadOrders">查询</button>
      <button class="btn-success" bindtap="exportOrders">导出</button>
    </view>
    <view class="batch-actions">
      <button class="btn-warning" disabled="{{!selectedNos.length}}" bindtap="batchAccept">批量接单</button>
      <button class="btn-info" bindtap="testVoice">语音测试</button>
    </view>
  </view>

  <scroll-view scroll-x class="order-tabs card">
    <view class="tab-list">
      <view wx:for="{{tabs}}" wx:key="key" class="tab-item {{activeTab === item.key ? 'active' : ''}}" bindtap="switchTab" data-key="{{item.key}}">
        {{item.label}}
      </view>
    </view>
  </scroll-view>

  <view class="table-container card">
    <!-- 订单列表 -->
    <view wx:if="{{activeTab !== 'complaint' && activeTab !== 'appeal'}}" class="admin-table">
      <view class="tr th">
        <view class="td checkbox"><checkbox checked="{{isAllSelected}}" bindtap="toggleAll" /></view>
        <view class="td no">订单号</view>
        <view class="td time">时间</view>
        <view class="td amount">金额</view>
        <view class="td status">状态</view>
        <view class="td ops">操作</view>
      </view>
      <view class="tr" wx:for="{{filteredOrders}}" wx:key="orderNo">
        <view class="td checkbox">
          <checkbox checked="{{item.selected}}" bindtap="toggleSelect" data-no="{{item.orderNo}}" />
        </view>
        <view class="td no">{{item.orderNo}}</view>
        <view class="td time">{{item.formattedTime}}</view>
        <view class="td amount">¥{{item.payAmount}}</view>
        <view class="td status">
          <text class="status-tag status-{{item.status}}">{{item.statusName}}</text>
        </view>
        <view class="td ops">
          <button wx:if="{{item.status === 'PAID'}}" size="mini" bindtap="handleOrder" data-no="{{item.orderNo}}" data-action="accept">接单</button>
          <button wx:if="{{item.status === 'MAKING'}}" size="mini" bindtap="handleOrder" data-no="{{item.orderNo}}" data-action="ready">完成制作</button>
          <button wx:if="{{item.status === 'DELIVERING'}}" size="mini" bindtap="handleOrder" data-no="{{item.orderNo}}" data-action="deliver">确认送达</button>
          <button wx:if="{{item.status === 'READY' || item.status === 'DELIVERED'}}" size="mini" bindtap="handleOrder" data-no="{{item.orderNo}}" data-action="complete">完成</button>
          <button size="mini" bindtap="printOrder" data-no="{{item.orderNo}}">打印</button>
          <button wx:if="{{item.status === 'REFUNDING'}}" size="mini" bindtap="showRefundModal" data-item="{{item}}">审核</button>
        </view>
      </view>
    </view>

    <!-- 申诉退款 -->
    <view wx:elif="{{activeTab === 'appeal'}}" class="admin-table">
      <view class="tr th">
        <view class="td no">订单号</view>
        <view class="td reason">原因</view>
        <view class="td amount">金额</view>
        <view class="td status">状态</view>
        <view class="td ops">操作</view>
      </view>
      <view class="tr" wx:for="{{appeals}}" wx:key="id">
        <view class="td no">{{item.orderNo}}</view>
        <view class="td reason">{{item.reason}}</view>
        <view class="td amount">¥{{item.amount}}</view>
        <view class="td status">{{item.status === 'PENDING' ? '待处理' : '已处理'}}</view>
        <view class="td ops">
          <button wx:if="{{item.status === 'PENDING'}}" size="mini" bindtap="handleAppeal" data-item="{{item}}">退款</button>
        </view>
      </view>
    </view>

    <!-- 投诉建议 -->
    <view wx:else class="admin-table">
      <view class="tr th">
        <view class="td user">用户ID</view>
        <view class="td type">类型</view>
        <view class="td content">内容</view>
        <view class="td status">状态</view>
        <view class="td ops">操作</view>
      </view>
      <view class="tr" wx:for="{{complaints}}" wx:key="id">
        <view class="td user">{{item.userId}}</view>
        <view class="td type">{{item.type}}</view>
        <view class="td content">{{item.content}}</view>
        <view class="td status">{{item.status}}</view>
        <view class="td ops">
          <button size="mini" bindtap="handleComplaint" data-item="{{item}}">处理</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 退款审核弹窗 -->
  <view wx:if="{{refundModal.show}}" class="modal-mask">
    <view class="modal-container">
      <view class="modal-title">退款审核 - {{refundModal.order.orderNo}}</view>
      <view class="modal-body">
        <view class="info-row">退款金额：<text class="text-danger">¥{{refundModal.order.payAmount}}</text></view>
        <view class="info-row">退款原因：{{refundModal.order.refundReason || '无'}}</view>
        <view class="form-item">
          <text class="label">审核意见：</text>
          <textarea class="admin-textarea" value="{{refundModal.reply}}" bindinput="onRefundReplyInput" />
        </view>
      </view>
      <view class="modal-footer">
        <button bindtap="hideRefundModal">取消</button>
        <button class="btn-danger" bindtap="submitRefund" data-approved="{{false}}">拒绝</button>
        <button class="btn-success" bindtap="submitRefund" data-approved="{{true}}">通过</button>
      </view>
    </view>
  </view>
</view>