<view class="product-manage">
  <view class="action-bar card">
    <view class="search-form">
      <input 
        class="admin-input" 
        placeholder="输入商品名称实时筛选..." 
        value="{{filterQuery.name}}"
        bindinput="onSearchInput"
      />
      <picker 
        bindchange="onCategoryChange" 
        value="{{categoryIndex}}" 
        range="{{categories}}" 
        range-key="name"
      >
        <view class="admin-select">
          {{categories[categoryIndex].name || '全部分类'}}
        </view>
      </picker>
      <button class="btn-primary" bindtap="loadProducts">同步数据</button>
    </view>
    <view class="batch-actions">
      <button class="btn-success" bindtap="showEditModal">新增商品</button>
      <button class="btn-warning" disabled="{{!selectedIds.length}}" bindtap="batchStatus" data-status="1">批量上架</button>
      <button class="btn-danger" disabled="{{!selectedIds.length}}" bindtap="batchStatus" data-status="0">批量下架</button>
    </view>
  </view>

  <view class="table-container card">
    <view class="admin-table">
      <view class="tr th">
        <view class="td checkbox"><checkbox checked="{{isAllSelected}}" bindtap="toggleAll" /></view>
        <view class="td img">图片</view>
        <view class="td name">名称</view>
        <view class="td price">价格</view>
        <view class="td stock">库存</view>
        <view class="td status">状态</view>
        <view class="td ops">操作</view>
      </view>
      <view class="tr" wx:for="{{filteredProducts}}" wx:key="id">
        <view class="td checkbox">
          <checkbox checked="{{item.selected}}" bindtap="toggleSelect" data-id="{{item.id}}" />
        </view>
        <view class="td img">
          <image src="{{item.imageUrl}}" class="table-img" mode="aspectFill" />
        </view>
        <view class="td name">{{item.name}}</view>
        <view class="td price">¥{{item.price}}</view>
        <view class="td stock {{item.stock <= item.alertThreshold ? 'text-danger' : ''}}">
          {{item.stock}}
          <text wx:if="{{item.stock <= item.alertThreshold}}" class="badge-warn">预警</text>
        </view>
        <view class="td status">
          <text class="{{item.status === 1 ? 'status-on' : 'status-off'}}">
            {{item.status === 1 ? '已上架' : '已下架'}}
          </text>
        </view>
        <view class="td ops">
          <button size="mini" bindtap="showEditModal" data-item="{{item}}">编辑</button>
          <button size="mini" bindtap="showRecipeModal" data-item="{{item}}">配方</button>
          <button size="mini" bindtap="toggleStatus" data-item="{{item}}">{{item.status === 1 ? '下架' : '上架'}}</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 编辑弹窗 -->
  <view wx:if="{{editModal.show}}" class="modal-mask">
    <view class="modal-container">
      <view class="modal-title">{{editModal.isEdit ? '编辑商品' : '新增商品'}}</view>
      <scroll-view scroll-y class="modal-body">
        <view class="form-item">
          <text class="label">商品名称</text>
          <input class="admin-input" value="{{editModal.form.name}}" bindinput="onFormInput" data-field="name" />
        </view>
        <view class="form-item">
          <text class="label">商品分类</text>
          <picker bindchange="onFormCategoryChange" value="{{formCategoryIndex}}" range="{{categories}}" range-key="name">
            <view class="admin-select">{{categories[formCategoryIndex].name || '请选择分类'}}</view>
          </picker>
        </view>
        <view class="form-item">
          <text class="label">价格</text>
          <input class="admin-input" type="digit" value="{{editModal.form.price}}" bindinput="onFormInput" data-field="price" />
        </view>
        <view class="form-item">
          <text class="label">库存</text>
          <input class="admin-input" type="number" value="{{editModal.form.stock}}" bindinput="onFormInput" data-field="stock" />
        </view>
        <view class="form-item">
          <text class="label">商品图片</text>
          <view class="upload-box" bindtap="handleUpload">
            <image wx:if="{{editModal.form.imageUrl}}" src="{{editModal.form.imageUrl}}" class="preview-img" mode="aspectFill" />
            <view wx:else class="upload-placeholder">+</view>
          </view>
        </view>
        <view class="form-item">
          <text class="label">描述</text>
          <textarea class="admin-textarea" value="{{editModal.form.description}}" bindinput="onFormInput" data-field="description" />
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button bindtap="hideEditModal">取消</button>
        <button class="btn-primary" bindtap="saveProduct">保存</button>
      </view>
    </view>
  </view>

  <!-- 配方管理弹窗 -->
  <view wx:if="{{recipeModal.show}}" class="modal-mask">
    <view class="modal-container recipe-modal">
      <view class="modal-title">配方管理 - {{recipeModal.product.name}}</view>
      <scroll-view scroll-y class="modal-body">
        <view wx:for="{{recipeModal.list}}" wx:key="index" class="recipe-row">
          <picker 
            bindchange="onRecipeIngredientChange" 
            data-index="{{index}}" 
            value="{{item.ingredientIndex}}" 
            range="{{ingredients}}" 
            range-key="name"
          >
            <view class="admin-select">{{ingredients[item.ingredientIndex].name || '选择原料'}}</view>
          </picker>
          <input class="admin-input" type="digit" placeholder="用量" value="{{item.quantity}}" bindinput="onRecipeQuantityInput" data-index="{{index}}" />
          <text class="btn-text-danger" bindtap="removeRecipeRow" data-index="{{index}}">删除</text>
        </view>
        <button class="btn-dashed" bindtap="addRecipeRow">+ 添加原料</button>
        <view class="recipe-summary">
          预估成本：<text class="text-danger">¥{{calculatedCost}}</text>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <button bindtap="hideRecipeModal">取消</button>
        <button class="btn-primary" bindtap="saveRecipe">保存配方</button>
      </view>
    </view>
  </view>
</view>